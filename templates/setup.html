{% extends "base.html" %} {% block title %}WiFi Setup - {{ device_name }}{% endblock %} {% block
status %}SELECT NETWORK{% endblock %} {% block content %}
<div class="setup-container">
  <div class="section-header">
    <h2>Select WiFi Network</h2>
    <p class="description">Choose your network from the list below</p>
  </div>

  <div class="network-list" id="networkList">
    {% for network in networks %}
    <div
      class="network-card"
      onclick="selectNetwork('{{ network.ssid }}', '{{ network.security }}')"
    >
      <div class="network-main">
        <div class="network-name">{{ network.ssid }}</div>
        <div class="network-meta">
          {% if network.security != "Open" %}
          <span class="security-badge locked">SECURE</span>
          {% else %}
          <span class="security-badge open">OPEN</span>
          {% endif %}
        </div>
      </div>
      <div class="network-signal">
        <div class="signal-indicator">
          <span class="signal-bar {{ 'active' if network.signal > 20 else '' }}"></span>
          <span class="signal-bar {{ 'active' if network.signal > 40 else '' }}"></span>
          <span class="signal-bar {{ 'active' if network.signal > 60 else '' }}"></span>
          <span class="signal-bar {{ 'active' if network.signal > 80 else '' }}"></span>
        </div>
        <span class="signal-value">{{ network.signal }}%</span>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="action-bar">
    <button class="btn btn-primary" onclick="refreshNetworks()">
      <span class="btn-text">REFRESH</span>
    </button>
  </div>

  <div class="divider"></div>

  <!-- Manual Network Entry Section -->
  <div class="manual-entry-section">
    <div class="section-header">
      <h2>Connect to Hidden Network</h2>
      <p class="description">Enter network details manually</p>
    </div>
    
    <form id="manualConnectForm" class="manual-entry-form">
      <div class="form-row">
        <div class="form-field form-field-inline">
          <label for="manualSsid">NETWORK NAME (SSID)</label>
          <input
            type="text"
            id="manualSsid"
            name="ssid"
            class="input-field"
            placeholder="Enter network name"
            maxlength="32"
            required
            autocomplete="off"
          />
        </div>
        
        <div class="form-field form-field-inline">
          <label for="manualPassword">PASSWORD</label>
          <div class="password-input-wrapper">
            <input
              type="password"
              id="manualPassword"
              name="password"
              class="input-field"
              placeholder="Enter password (optional)"
              maxlength="63"
              autocomplete="off"
            />
            <button type="button" class="password-toggle" onclick="toggleManualPassword()" title="Show password">
              <span id="manualToggleIcon">[SHOW]</span>
            </button>
          </div>
        </div>
        
        <div class="form-field form-field-button">
          <button type="submit" class="btn btn-primary">CONNECT</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Password Modal -->
<div id="passwordModal" class="modal hidden">
  <div class="modal-backdrop" onclick="closePasswordModal()"></div>
  <div class="modal-dialog">
    <div class="modal-header">
      <h3>Enter WiFi Password</h3>
      <button class="modal-close" onclick="closePasswordModal()">&times;</button>
    </div>

    <form id="connectForm" method="POST" action="/connect">
      <input type="hidden" id="ssidInput" name="ssid" value="" />

      <div class="modal-body">
        <div class="form-field">
          <label for="passwordInput">PASSWORD</label>
          <div class="password-input-wrapper">
            <input
              type="password"
              id="passwordInput"
              name="password"
              class="input-field"
              autocomplete="off"
              placeholder="Enter WiFi password"
            />
            <button type="button" class="password-toggle" onclick="togglePassword()" title="Show password">
              <span id="toggleIcon">[SHOW]</span>
            </button>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">CONNECT</button>
        <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">
          CANCEL
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  function selectNetwork(ssid, security) {
    if (security === 'Open') {
      // Direct connection for open networks
      document.getElementById('ssidInput').value = ssid;
      document.getElementById('passwordInput').value = '';
      document.getElementById('connectForm').submit();
    } else {
      // Show password modal for secured networks
      document.getElementById('ssidInput').value = ssid;
      document.getElementById('passwordModal').classList.remove('hidden');
      document.getElementById('passwordInput').focus();
    }
  }

  function closePasswordModal() {
    document.getElementById('passwordModal').classList.add('hidden');
    document.getElementById('passwordInput').value = '';
  }

  function refreshNetworks() {
    location.reload();
  }

  function togglePassword() {
    const passwordInput = document.getElementById('passwordInput');
    const toggleIcon = document.getElementById('toggleIcon');
    
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      toggleIcon.textContent = '[HIDE]';
    } else {
      passwordInput.type = 'password';
      toggleIcon.textContent = '[SHOW]';
    }
  }

  function toggleManualPassword() {
    const passwordInput = document.getElementById('manualPassword');
    const toggleIcon = document.getElementById('manualToggleIcon');
    
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      toggleIcon.textContent = '[HIDE]';
    } else {
      passwordInput.type = 'password';
      toggleIcon.textContent = '[SHOW]';
    }
  }

  function showConnectingModal(ssid) {
    // Create or show modal with connecting message
    let modal = document.getElementById('connectingModal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'connectingModal';
      modal.className = 'modal';
      document.body.appendChild(modal);
    }
    
    modal.innerHTML = `
      <div class="modal-backdrop"></div>
      <div class="modal-dialog" style="margin-top: 100px;">
        <div class="modal-header">
          <h3 style="font-family: var(--font-heading);">CONNECTING TO WIFI</h3>
        </div>
        <div class="modal-body" style="text-align: center; padding: 3rem 2rem;">
          <p style="font-size: 1.2rem; margin-bottom: 2rem;">
            Network: <strong style="font-family: var(--font-semibold);">${ssid}</strong>
          </p>
          <div style="margin: 2rem 0;">
            <div class="progress-bar" style="border: 2px solid #000; height: 8px; background: #fff; position: relative; overflow: hidden;">
              <div style="position: absolute; left: 0; top: 0; height: 100%; width: 30%; background: #000; animation: progress 2s ease-in-out infinite;"></div>
            </div>
          </div>
          <p style="margin: 1.5rem 0;">Please wait while we connect to your network...</p>
          <p style="margin: 1rem 0; font-size: 0.9rem;">This may take up to 30 seconds.</p>
          <hr style="border: none; border-top: 2px solid #000; margin: 2rem 0;">
          <p style="font-size: 0.85rem; opacity: 0.7;">The device will restart its network connection.</p>
          <p style="font-size: 0.85rem; opacity: 0.7;">You may need to reconnect to view the status.</p>
        </div>
      </div>
      <style>
        @keyframes progress {
          0% { left: -30%; }
          50% { left: 100%; }
          100% { left: -30%; }
        }
      </style>
    `;
    
    modal.classList.remove('hidden');
  }

  // Handle escape key to close modal
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
      closePasswordModal();
    }
  });

  // Handle manual network connection form
  document.getElementById('manualConnectForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const ssid = document.getElementById('manualSsid').value.trim();
    const password = document.getElementById('manualPassword').value;
    
    // Validate SSID
    if (!ssid || ssid.length === 0) {
      alert('Please enter a network name');
      return;
    }
    
    if (!/^[a-zA-Z0-9\s\-_.]+$/.test(ssid)) {
      alert('Network name contains invalid characters');
      return;
    }
    
    // Validate password if provided
    if (password) {
      if (password.length < 8 || password.length > 63) {
        alert('Password must be 8-63 characters');
        return;
      }
    }
    
    // Show connecting modal
    showConnectingModal(ssid);
    
    // Submit connection request
    try {
      const response = await fetch('/api/connect', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ssid, password: password || null})
      });
      
      // Try to redirect after 10 seconds
      setTimeout(() => {
        window.location.href = '/status';
      }, 10000);
      
    } catch (error) {
      console.log('Network connection changed, this is expected');
      setTimeout(() => {
        window.location.href = '/status';
      }, 15000);
    }
  });

  // Override form submission to use AJAX instead of regular POST
  document.getElementById('connectForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const ssid = document.getElementById('ssidInput').value;
    const password = document.getElementById('passwordInput').value;
    
    // Show connecting modal
    closePasswordModal();
    showConnectingModal(ssid);
    
    // Submit via AJAX
    try {
      const response = await fetch('/api/connect', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ssid, password})
      });
      
      // Connection initiated - page stays loaded
      // WebSocket will update when connection changes
      
      // Try to redirect after 10 seconds
      setTimeout(() => {
        window.location.href = '/status';
      }, 10000);
      
    } catch (error) {
      // Network dropped - this is expected behavior
      console.log('Network connection changed, this is expected');
      
      // Still try to redirect after delay
      setTimeout(() => {
        window.location.href = '/status';
      }, 15000);
    }
  });
</script>
{% endblock %}
