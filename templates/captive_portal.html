{% extends "base.html" %}

{% block title %}Captive Portal Authentication - {{ device_name }}{% endblock %}

{% block status %}AUTHENTICATE{% endblock %}

{% block content %}
<div class="captive-portal-container">
  <div class="portal-header">
    <h1 class="portal-title">Captive Portal Authentication</h1>

    <!-- Status Banner -->
    <div id="status" class="status-banner status-loading">
      <div class="status-content">
        <svg id="status-icon" class="status-spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        <p>
          <span id="status-text" class="status-text-content">Connecting to captive portal...</span>
        </p>
      </div>
    </div>

    <!-- Error Banner (hidden by default) -->
    <div id="error-banner" class="hidden error-banner">
      <div class="error-content">
        <svg class="error-icon-svg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div class="error-text-wrapper">
          <p id="error-text" class="error-text-title"></p>
          <p id="error-details" class="error-text-details"></p>
          <div class="error-actions">
            <button onclick="retryPortal()" class="btn btn-primary btn-small">
              RETRY
            </button>
            <button onclick="window.location.href='/'" class="btn btn-secondary btn-small">
              RETURN TO SETUP
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Instructions -->
    <div id="instructions" class="info-card">
      <h3 class="instructions-title">INSTRUCTIONS:</h3>
      <ol class="instructions-list">
        <li>Complete the authentication below using the portal's web interface</li>
        <li>The page will automatically update when authentication succeeds</li>
        <li>You may need to accept terms, enter credentials, or complete a payment</li>
      </ol>
    </div>

    <!-- Manual Controls -->
    <div class="portal-controls">
      <button onclick="refreshPortal()" class="btn btn-outline btn-small">
        <span class="btn-icon">↻</span> REFRESH PORTAL
      </button>
      <button onclick="checkConnectionStatus()" class="btn btn-outline btn-small">
        <span class="btn-icon">✓</span> CHECK CONNECTION
      </button>
      <button onclick="toggleDebugInfo()" class="btn btn-outline btn-small">
        <span class="btn-icon">ℹ</span> DEBUG INFO
      </button>
      <button onclick="toggleFullscreen()" class="btn btn-outline btn-small mobile-only">
        <span class="btn-icon">⛶</span> FULLSCREEN
      </button>
    </div>
  </div>

  <!-- Portal Container with Loading Overlay -->
  <div id="portal-container" class="portal-frame-container">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="portal-loading-overlay">
      <div class="loading-content">
        <div class="retro-loader">
          <div class="retro-blocks">
            <span class="block"></span>
            <span class="block"></span>
            <span class="block"></span>
            <span class="block"></span>
            <span class="block"></span>
            <span class="block"></span>
            <span class="block"></span>
            <span class="block"></span>
          </div>
          <div class="retro-text">LOADING...</div>
        </div>
        <p class="loading-text">Loading portal...</p>
        <p class="loading-subtext">This may take a few seconds</p>
      </div>
    </div>

    <!-- Portal Iframe -->
    <iframe
      id="portal-frame"
      src="/api/proxy?url={{ portal_url }}"
      sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox"
      class="portal-iframe"
      title="Captive Portal">
    </iframe>
  </div>

  <!-- Success Container -->
  <div id="success-container" class="hidden">
    <div class="status-card success">
      <div class="status-icon">
        <div class="checkmark"></div>
      </div>
      <h2 class="success-title">Authentication Successful!</h2>
      <p class="status-subtitle">
        You now have internet access. You can close this page.
      </p>
      <div class="action-section">
        <a href="/" class="btn btn-primary">
          RETURN TO DASHBOARD
        </a>
      </div>
    </div>
  </div>

  <!-- Debug Info (collapsible) -->
  <div id="debug-info" class="hidden detail-card">
    <h3>DEBUG INFORMATION</h3>
    <div class="detail-grid">
      <div class="detail-row">
        <span class="detail-label">Device IP:</span>
        <span class="detail-value">{{ device_ip }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Portal URL:</span>
        <span class="detail-value portal-url-text">{{ portal_url }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Device Name:</span>
        <span class="detail-value">{{ device_name }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Page Loaded:</span>
        <span id="page-load-time" class="detail-value"></span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Portal Load Time:</span>
        <span id="portal-load-time" class="detail-value">Pending...</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Last Status Check:</span>
        <span id="last-status-check" class="detail-value">Never</span>
      </div>
    </div>
  </div>
</div>

<!-- CSS for captive portal -->
<style>
  .captive-portal-container {
    max-width: 1000px;
    margin: 0 auto;
  }

  .portal-header {
    margin-bottom: 2rem;
  }

  .portal-title {
    font-family: var(--font-heading);
    font-size: 1.75rem;
    margin-bottom: 1.5rem;
  }

  /* Status Banner */
  .status-banner {
    margin-bottom: 1.5rem;
    padding: 1rem;
    border: var(--border-width) solid var(--black);
  }

  .status-loading {
    background: repeating-linear-gradient(
      90deg,
      var(--white),
      var(--white) 10px,
      transparent 10px,
      transparent 11px
    );
  }

  .status-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .status-spinner {
    width: 1.25rem;
    height: 1.25rem;
    animation: spin 2s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .status-text-content {
    font-family: var(--font-semibold);
  }

  /* Error Banner */
  .error-banner {
    margin-bottom: 1.5rem;
    padding: 1rem;
    border: var(--border-width) solid var(--black);
  }

  .error-content {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
  }

  .error-icon-svg {
    width: 1.25rem;
    height: 1.25rem;
    flex-shrink: 0;
    margin-top: 0.125rem;
  }

  .error-text-wrapper {
    flex: 1;
  }

  .error-text-title {
    font-family: var(--font-semibold);
    font-weight: bold;
    margin-bottom: 0.5rem;
  }

  .error-text-details {
    font-size: 0.875rem;
    margin-bottom: 1rem;
  }

  .error-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  /* Instructions */
  .instructions-title {
    font-family: var(--font-semibold);
    font-size: 1rem;
    margin-bottom: 0.75rem;
  }

  .instructions-list {
    list-style-position: inside;
    margin: 0;
    padding: 0;
  }

  .instructions-list li {
    padding: 0.25rem 0;
    font-size: 0.9375rem;
  }

  /* Portal Controls */
  .portal-controls {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
  }

  .btn-small {
    padding: 0.5rem 1rem;
    font-size: 0.75rem;
  }

  .btn-icon {
    display: inline-block;
    margin-right: 0.25rem;
  }

  .mobile-only {
    display: none;
  }

  @media (width <= 768px) {
    .mobile-only {
      display: inline-flex;
    }
  }

  /* Portal Frame Container */
  .portal-frame-container {
    position: relative;
    border: var(--border-width) solid var(--black);
    overflow: hidden;
    background: var(--white);
    margin-bottom: 2rem;
  }

  .portal-loading-overlay {
    position: absolute;
    inset: 0;
    background: var(--white);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }

  .portal-loading-overlay.hidden {
    display: none;
  }

  .loading-content {
    text-align: center;
  }

  .loading-text {
    font-family: var(--font-semibold);
    margin-top: 1rem;
  }

  .loading-subtext {
    font-size: 0.875rem;
    opacity: 0.7;
    margin-top: 0.5rem;
  }

  .portal-iframe {
    width: 100%;
    border: 0;
    height: min(600px, 70vh);
  }

  /* Success */
  .success-title {
    font-family: var(--font-heading);
    font-size: 1.75rem;
    margin-bottom: 1rem;
  }

  /* Debug Info */
  .portal-url-text {
    word-break: break-all;
    font-size: 0.75rem;
  }

  .detail-grid {
    display: grid;
    gap: 0.75rem;
  }

  /* Responsive */
  @media (width <= 768px) {
    .portal-title {
      font-size: 1.5rem;
    }

    .portal-controls {
      flex-direction: column;
    }

    .portal-controls .btn {
      width: 100%;
    }

    .error-actions {
      flex-direction: column;
    }

    .error-actions .btn {
      width: 100%;
    }
  }
</style>

<script>
  // State variables
  let checkInterval = null;
  let isAuthenticated = false;
  let portalLoadStartTime = Date.now();
  let isFullscreen = false;
  let websocket = null;
  let wsReconnectAttempts = 0;
  const WS_MAX_RECONNECT_ATTEMPTS = 5;

  // Initialize page load time
  document.getElementById('page-load-time').textContent = new Date().toLocaleString();

  // WebSocket connection for real-time updates
  function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws`;

    try {
      websocket = new WebSocket(wsUrl);

      websocket.onopen = function() {
        console.log('WebSocket connected');
        wsReconnectAttempts = 0;
      };

      websocket.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          console.log('WebSocket message:', data);

          // Handle captive portal cleared event
          if (data.type === 'captive_portal_cleared') {
            console.log('Captive portal authentication successful!');
            if (!isAuthenticated) {
              isAuthenticated = true;
              showSuccess();
            }
          }
          // Handle regular status updates
          else if (data.type === 'status') {
            // Check if captive portal was cleared
            if (data.state === 'CONNECTED' && !data.captive_portal_url && !isAuthenticated) {
              isAuthenticated = true;
              showSuccess();
            }
          }
        } catch (e) {
          console.error('Error parsing WebSocket message:', e);
        }
      };

      websocket.onerror = function(error) {
        console.error('WebSocket error:', error);
      };

      websocket.onclose = function() {
        console.log('WebSocket disconnected');
        websocket = null;

        // Attempt reconnection with exponential backoff
        if (wsReconnectAttempts < WS_MAX_RECONNECT_ATTEMPTS && !isAuthenticated) {
          wsReconnectAttempts++;
          const delay = Math.min(1000 * Math.pow(2, wsReconnectAttempts), 10000);
          console.log(`Attempting WebSocket reconnection in ${delay}ms (attempt ${wsReconnectAttempts})`);
          setTimeout(connectWebSocket, delay);
        }
      };
    } catch (e) {
      console.error('Failed to create WebSocket connection:', e);
    }
  }

  // Initialize WebSocket connection
  connectWebSocket();

  // Update status indicator
  function updateStatus(type, text) {
    const statusDiv = document.getElementById('status');
    const statusText = document.getElementById('status-text');
    const statusIcon = document.getElementById('status-icon');

    statusText.textContent = text;

    // Update styling based on type
    statusDiv.className = 'status-banner';
    statusIcon.classList.remove('status-spinner');

    if (type === 'loading') {
      statusDiv.classList.add('status-loading');
      statusIcon.classList.add('status-spinner');
    }
  }

  // Show error banner
  function showError(errorText, errorDetails = '') {
    const errorBanner = document.getElementById('error-banner');
    const errorTextEl = document.getElementById('error-text');
    const errorDetailsEl = document.getElementById('error-details');

    errorTextEl.textContent = errorText;
    errorDetailsEl.textContent = errorDetails;
    errorBanner.classList.remove('hidden');

    updateStatus('error', 'Portal loading failed');
  }

  // Hide error banner
  function hideError() {
    document.getElementById('error-banner').classList.add('hidden');
  }

  // Check authentication status
  async function checkAuthenticationStatus() {
    try {
      const response = await fetch('/api/status');
      const data = await response.json();

      // Update last check time
      document.getElementById('last-status-check').textContent = new Date().toLocaleString();

      // Check if we have internet now (captive portal cleared)
      if (data.state === 'CONNECTED' && !data.error && !isAuthenticated) {
        // Check if captive_portal_url is cleared
        if (!data.error || !data.error.includes('captive portal')) {
          isAuthenticated = true;
          showSuccess();
        }
      }
    } catch (e) {
      console.error('Status check failed:', e);
    }
  }

  // Show success message
  function showSuccess() {
    // Clear the interval
    if (checkInterval) {
      clearInterval(checkInterval);
      checkInterval = null;
    }

    updateStatus('success', 'Authentication successful! You now have internet access.');

    // Hide instructions, error banner, and iframe
    document.getElementById('instructions').style.display = 'none';
    document.getElementById('error-banner').classList.add('hidden');
    document.getElementById('portal-container').style.display = 'none';

    // Show success message
    document.getElementById('success-container').classList.remove('hidden');

    // Optional: Play success sound (browser beep)
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      gainNode.gain.value = 0.1;

      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.2);
    } catch (e) {
      // Audio not supported or blocked
    }
  }

  // Manual control functions
  function refreshPortal() {
    const iframe = document.getElementById('portal-frame');
    const loadingOverlay = document.getElementById('loading-overlay');

    hideError();
    loadingOverlay.classList.remove('hidden');
    updateStatus('loading', 'Refreshing portal...');

    iframe.src = iframe.src;
    portalLoadStartTime = Date.now();
  }

  function checkConnectionStatus() {
    updateStatus('loading', 'Checking connection...');
    checkAuthenticationStatus();
  }

  function retryPortal() {
    hideError();
    refreshPortal();
  }

  function toggleDebugInfo() {
    const debugInfo = document.getElementById('debug-info');
    debugInfo.classList.toggle('hidden');
  }

  function toggleFullscreen() {
    const portalContainer = document.getElementById('portal-container');
    const iframe = document.getElementById('portal-frame');

    if (!isFullscreen) {
      // Enter fullscreen
      if (portalContainer.requestFullscreen) {
        portalContainer.requestFullscreen();
      } else if (portalContainer.webkitRequestFullscreen) {
        portalContainer.webkitRequestFullscreen();
      } else if (portalContainer.msRequestFullscreen) {
        portalContainer.msRequestFullscreen();
      }
      iframe.style.height = '100vh';
      isFullscreen = true;
    } else {
      // Exit fullscreen
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
      iframe.style.height = 'min(600px, 70vh)';
      isFullscreen = false;
    }
  }

  // Handle fullscreen changes
  document.addEventListener('fullscreenchange', function() {
    if (!document.fullscreenElement) {
      const iframe = document.getElementById('portal-frame');
      iframe.style.height = 'min(600px, 70vh)';
      isFullscreen = false;
    }
  });

  // Iframe event handlers
  const iframe = document.getElementById('portal-frame');
  const loadingOverlay = document.getElementById('loading-overlay');

  iframe.addEventListener('load', function() {
    // Hide loading overlay
    loadingOverlay.classList.add('hidden');

    // Calculate load time
    const loadTime = ((Date.now() - portalLoadStartTime) / 1000).toFixed(2);
    document.getElementById('portal-load-time').textContent = loadTime + 's';

    updateStatus('info', 'Portal loaded. Complete the authentication below.');
    hideError();
  });

  iframe.addEventListener('error', function() {
    loadingOverlay.classList.add('hidden');
    showError(
      'Failed to load captive portal',
      'The portal server may be unreachable. Try refreshing or check your connection.'
    );
  });

  // Start checking for authentication success every 5 seconds
  checkInterval = setInterval(checkAuthenticationStatus, 5000);

  // Check immediately on page load
  checkAuthenticationStatus();

  // Clean up resources when page is unloaded
  window.addEventListener('beforeunload', function() {
    if (checkInterval) {
      clearInterval(checkInterval);
    }
    if (websocket) {
      websocket.close();
    }
  });
</script>
{% endblock %}
