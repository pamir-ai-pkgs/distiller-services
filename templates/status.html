{% extends "base.html" %} {% block title %}Connected - {{ device_name }}{% endblock %} {% block
status %}CONNECTED{% endblock %} {% block content %}
<div class="status-container">
  <div class="status-card success">
    <div class="status-icon">
      <div class="checkmark"></div>
    </div>
    <h2>Connected Successfully</h2>
    <p class="status-subtitle">Your device is now online</p>
  </div>

  <div class="connection-details">
    <div class="detail-card">
      <h3>Network Information</h3>
      <div class="detail-grid">
        <div class="detail-row">
          <span class="detail-label">Network</span>
          <span class="detail-value">{{ ssid | default('N/A') }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">IP Address</span>
          <span class="detail-value">{{ ip_address | default('Obtaining...') }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Hostname</span>
          <span class="detail-value">{{ device_name }}.local</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status</span>
          <span class="detail-value status-online">ONLINE</span>
        </div>
      </div>
    </div>

    {% if tunnel_url %}
    <div class="detail-card">
      <h3>Remote Access</h3>
      <div class="tunnel-info">
        <p class="tunnel-label">Remote Tunnel Active</p>
        <div class="tunnel-url">
          <a href="{{ tunnel_url }}" target="_blank" class="url-link">{{ tunnel_url }}</a>
          <button class="copy-btn" onclick="copyToClipboard('{{ tunnel_url }}')">COPY</button>
        </div>
        <p class="tunnel-note">Use this URL to access your device from anywhere</p>
      </div>
    </div>
    {% else %}
    <div class="detail-card">
      <h3>Remote Access</h3>
      <div class="tunnel-info">
        <p class="tunnel-status">Remote tunnel not connected</p>
        <p class="tunnel-note">Remote access will be available shortly...</p>
      </div>
    </div>
    {% endif %}
  </div>

  <div class="action-section">
    <button class="btn btn-secondary" onclick="changeNetwork()">
      <span class="btn-text">CHANGE NETWORK</span>
    </button>
    <button class="btn btn-outline" onclick="refreshStatus()">
      <span class="btn-text">REFRESH</span>
    </button>
  </div>

  <div class="help-card">
    <h4>Access Information</h4>
    <div class="access-info">
      <div class="access-method">
        <span class="access-label">Local Access:</span>
        <code>http://{{ device_name }}.local:{{ port | default('8080') }}</code>
      </div>
      {% if tunnel_url %}
      <div class="access-method">
        <span class="access-label">Remote Access:</span>
        <code>{{ tunnel_url }}</code>
      </div>
      {% endif %}
    </div>
    <p class="help-note">The connection will persist across device reboots.</p>
  </div>
</div>

<script>
  // Copy to clipboard function
  function copyToClipboard(text) {
    navigator.clipboard
      .writeText(text)
      .then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'COPIED!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove('copied');
        }, 2000);
      })
      .catch((err) => {
        console.error('Failed to copy:', err);
      });
  }

  function changeNetwork() {
    if (
      confirm('This will disconnect from the current network and restart WiFi setup. Continue?')
    ) {
      fetch('/api/disconnect', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
      }).then(() => {
        setTimeout(() => {
          window.location.href = '/';
        }, 2000);
      });
    }
  }

  function refreshStatus() {
    window.location.reload();
  }

  // WebSocket for real-time updates
  let ws = null;

  function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.state !== 'CONNECTED') {
        // Lost connection, redirect to setup
        window.location.href = '/';
      }
      // Update tunnel URL if it changes
      if (data.tunnel_url && !document.querySelector('.tunnel-url')) {
        location.reload();
      }
    };

    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
    };

    ws.onclose = () => {
      // Attempt reconnection
      setTimeout(connectWebSocket, 5000);
    };
  }

  // Periodic status check
  function checkStatus() {
    fetch('/api/status')
      .then((response) => response.json())
      .then((data) => {
        if (data.state !== 'CONNECTED') {
          window.location.href = '/';
        }
      })
      .catch((error) => {
        console.error('Status check failed:', error);
      });
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    connectWebSocket();
    setInterval(checkStatus, 10000);
  });
</script>
{% endblock %}
