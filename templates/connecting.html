{% extends "base.html" %} {% block title %}Connecting - {{ device_name }}{% endblock %} {% block
status %}CONNECTING{% endblock %} {% block content %}
<div class="connecting-container">
  <div class="connection-card">
    <div class="progress-section">
      <div class="spinner">
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
      </div>

      <h2>Connecting to Network</h2>
      <p class="network-name">{{ ssid }}</p>
    </div>

    <div class="status-message">
      <p id="statusText">Establishing connection...</p>
    </div>

    <div class="progress-bar">
      <div class="progress-track">
        <div class="progress-fill" id="progressBar"></div>
      </div>
    </div>

    <div class="connection-steps">
      <div class="step" id="step1">
        <span class="step-indicator"></span>
        <span class="step-text">Authenticating</span>
      </div>
      <div class="step" id="step2">
        <span class="step-indicator"></span>
        <span class="step-text">Obtaining IP Address</span>
      </div>
      <div class="step" id="step3">
        <span class="step-indicator"></span>
        <span class="step-text">Verifying Connection</span>
      </div>
    </div>
  </div>

  <div class="info-card">
    <p class="info-text">
      Please wait while we connect to your WiFi network. This may take up to 30 seconds.
    </p>
    <p class="info-text">Do not close this window or refresh the page.</p>
  </div>
</div>

<script>
  // WebSocket connection for real-time updates
  let ws = null;
  let reconnectAttempts = 0;
  const maxReconnectAttempts = 10;
  let progressValue = 0;
  let currentStep = 1;

  function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws`;

    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
      console.log('WebSocket connected');
      reconnectAttempts = 0;
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      handleStatusUpdate(data);
    };

    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
    };

    ws.onclose = () => {
      console.log('WebSocket disconnected');
      if (reconnectAttempts < maxReconnectAttempts) {
        reconnectAttempts++;
        setTimeout(connectWebSocket, 2000);
      }
    };
  }

  function handleStatusUpdate(data) {
    if (data.state === 'CONNECTED') {
      // Connection successful
      progressValue = 100;
      updateProgress();
      updateStep(3, true);
      document.getElementById('statusText').textContent = 'Connection successful! Redirecting...';
      setTimeout(() => {
        window.location.href = '/status';
      }, 1500);
    } else if (data.state === 'FAILED') {
      // Connection failed
      document.getElementById('statusText').textContent =
        'Connection failed. Redirecting to setup...';
      setTimeout(() => {
        window.location.href = '/';
      }, 2000);
    }
  }

  function updateProgress() {
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = progressValue + '%';
  }

  function updateStep(step, complete = false) {
    const stepElement = document.getElementById('step' + step);
    if (stepElement) {
      if (complete) {
        stepElement.classList.add('complete');
      } else {
        stepElement.classList.add('active');
      }
    }
  }

  // Simulate progress animation
  function animateProgress() {
    if (progressValue < 90) {
      progressValue += Math.random() * 10;
      if (progressValue > 90) progressValue = 90;

      updateProgress();

      // Update steps based on progress
      if (progressValue > 30 && currentStep === 1) {
        updateStep(1, true);
        updateStep(2);
        currentStep = 2;
        document.getElementById('statusText').textContent = 'Obtaining IP address...';
      } else if (progressValue > 60 && currentStep === 2) {
        updateStep(2, true);
        updateStep(3);
        currentStep = 3;
        document.getElementById('statusText').textContent = 'Verifying connection...';
      }

      setTimeout(animateProgress, 500 + Math.random() * 1000);
    }
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    connectWebSocket();
    updateStep(1);
    setTimeout(animateProgress, 500);
  });

  // Fallback redirect after timeout
  setTimeout(() => {
    if (progressValue < 100) {
      window.location.href = '/';
    }
  }, 30000);
</script>
{% endblock %}
