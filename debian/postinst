#!/bin/sh
set -e

case "$1" in
configure)
	# Stop old service if running (migration from older versions)
	if [ -d /run/systemd/system ] && systemctl is-active --quiet distiller-wifi.service 2>/dev/null; then
		echo "INFO: Stopping distiller-wifi service for migration..."
		deb-systemd-invoke stop distiller-wifi.service 2>/dev/null || true
	fi

	# Create required directories with correct permissions
	install -d -m 0755 /etc/distiller
	install -d -m 0755 /var/lib/distiller
	install -d -m 0755 /var/log/distiller

	# Create virtual environment with uv
	cd /usr/lib/distiller-services

	[ -d .venv ] && rm -rf .venv

	uv venv --python $(which python3) --system-site-packages || {
		echo "ERROR: Failed to create virtual environment" >&2
		exit 1
	}

	export UV_COMPILE_BYTECODE=1
	export UV_NO_CACHE=1
	export UV_LINK_MODE=copy

	uv sync --frozen --no-editable --compile-bytecode || {
		echo "ERROR: Failed to install package" >&2
		exit 1
	}

	# Install distiller-sdk if available
	# if [ -d /opt/distiller-sdk ]; then
	# 	echo "INFO: Installing distiller-sdk dependency..."
	# 	uv pip install --python .venv/bin/python /opt/distiller-sdk || {
	# 		echo "WARNING: Failed to install distiller-sdk"
	# 	}
	# fi

	# Set MAC-based hostname on target devices
	if [ -f /boot/armbianEnv.txt ] || [ -f /boot/firmware/config.txt ]; then
		if [ -x /usr/share/distiller-services/scripts/update-hostname.sh ]; then
			systemctl is-system-running >/dev/null 2>&1 &&
				/usr/share/distiller-services/scripts/update-hostname.sh -v || true
		fi
	fi

	echo "INFO: distiller-services installed successfully."
	echo "INFO: Start service: sudo systemctl start distiller-wifi"
	;;

abort-upgrade | abort-remove | abort-deconfigure) ;;

*)
	echo "ERROR: postinst called with unknown argument: $1" >&2
	exit 1
	;;
esac

#DEBHELPER#

exit 0
